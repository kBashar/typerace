<!DOCTYPE html>
<html>
    <head>
    <title> Type race</title>
    <script type='text/javascript' src='CountDownTimer.js'></script>
    <script type='text/javascript' src='paragraph.js'></script>
    </head>
    <style>
        .wrong {
            color: red;
        }
        .currentWord {
            background-color: greenyellow;
        }
        .doneWord {
            color: lawngreen
        }
    </style>
    <script>
        /**TODO this will be populated automatically */
        var paragraph = new Paragraph("This makes sense because proof-reading");
        
        function inputCheck() {
            
            var expectedWord = paragraph.getCurrentWord() + " ";
            var dom = document.getElementById('userInput')
            var typed = dom.value;
            
            console.log(typed)
            
            if(!expectedWord.startsWith(typed) && (dom.getAttribute('class') != 'wrong')) {
                dom.setAttribute('class', 'wrong')
            }
            else if(expectedWord.startsWith(typed) && (dom.getAttribute('class') == 'wrong')) {
                dom.removeAttribute('class')
            }
            
            if(!expectedWord.localeCompare(typed)) {
                
                dom.value = ''         
                paragraph.updateCurrentWordIndex() 
                updateTextBlock(paragraph.getCurrentIndex())
            }
        };
        
        function updateTextBlock(presentIndex) {
            if(presentIndex !== -1) {
                var previousWordId = 'word' + (presentIndex - 1)
                var currentWordId = 'word' + presentIndex
                console.log("previousWordId: " + previousWordId)
                document.getElementById(previousWordId).removeAttribute('class')
                document.getElementById(previousWordId).setAttribute('class', 'doneWord')
                document.getElementById(currentWordId).setAttribute('class', 'currentWord')
            }
            else {
                var previousWordId = 'word' + (paragraph.getArray().length - 1)
                document.getElementById(previousWordId).removeAttribute('class')
                document.getElementById(previousWordId).setAttribute('class', 'doneWord')
            }
        }
        
        function spanify(wordArray) {
            var html = ""
            for(i = 0; i < wordArray.length; i++) {
                var id = 'word'+i
                html  = html + "<span id="+ id +">" + wordArray[i] +"</span> " 
            }
            return html  
        } 
        
        
        /**
         * Race will start in given seconds
         */
        function startRaceIn(timeSeconds) {
            var raceBoard = document.querySelector("#raceBoard");
            raceBoard.innerHTML = "<h1>Test start in: <span id = 'startTimer'></span></h1></br>";
            
            var userInput = document.querySelector("#userInput");
            var timerDisplay = document.querySelector("#startTimer");
            
            var cdTimer = new CountDownTimer(timeSeconds,1000);
            
            cdTimer.onTick(function(obj){
                
                displayTime(timerDisplay, obj)
                
                // Time is up
                if(obj.minutes === 0 && obj.seconds === 0) {
                    userInput.disabled = false;
                    userInput.focus();
                    startRace();
                }
            })
            cdTimer.start()
        }
        
        function displayTime(dom, timeObj) {
            var minutes = timeObj.minutes < 10 ? '0' + timeObj.minutes : timeObj.minutes
            var seconds = timeObj.seconds < 10 ? '0' + timeObj.seconds : timeObj.seconds
            var cdString = minutes + ":" + seconds
            dom.textContent = cdString;
        }
        
        function displayWPM(dom, wpm) {
            wpm = wpm < 10 ? "0"+wpm : wpm
            dom.textContent = wpm
        }
        
        function wpmCalculator(totalCharacterCount, timePassedInSeconds) {
            //console.log("total char: "+ totalCharacterCount);
            var totalWord = totalCharacterCount/5;
            var WPS = totalWord/timePassedInSeconds; 
            var WPM = Math.round(WPS*60);
            //console.log("totalWord: " + totalWord +" WPS: " + WPS + " WPM: " +WPM)
            return WPM;
        }
        
        function getTotalCharacterCount() {
            var typedCharLength = document.querySelector("#userInput").value.length;
            console.log("typedsCharLength: " + typedCharLength)
            console.log("previously typed: " + paragraph.getTotalCharCountAtIndex(paragraph.getCurrentIndex()-1))
            return paragraph.getTotalCharCountAtIndex(paragraph.getCurrentIndex()-1) + typedCharLength
        }
        
        function startRace() {
            var raceBoard = document.querySelector("#raceBoard");
            raceBoard.innerHTML = "<h2>Time left: <span id = 'raceTimer'></span></h2>"+
                                   "<h2>WPM: <span id= 'wpm'></span></br>";
            var raceTimeDisplay = document.querySelector("#raceTimer");
            var wpmDisplay = document.querySelector("#wpm");
            
            var cdTimer = new CountDownTimer(60,1000);
            cdTimer.onTick(function(timeObj){
                displayTime(raceTimeDisplay,timeObj)
                displayWPM(wpmDisplay, 
                           wpmCalculator(getTotalCharacterCount(), timeObj.timePassed));
            })
            cdTimer.start()
        }
        
        /** This implementation is going to be changed in final version */
        window.onload = function() {
            startRaceIn(2)
        }
                             
        </script>
    <body>
        <div id = "raceBoard">
            
        </div>
        <div id = "wordContainer">
        </div>
        <input type="text" id = "userInput" disabled = "disabled" onkeyup="inputCheck()"/>
        <script>
           document.getElementById("wordContainer").innerHTML = spanify(paragraph.getArray())
           document.getElementById("word0").setAttribute('class', 'currentWord') 
         </script>
    </body>
    </html>